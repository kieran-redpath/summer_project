---
title: "CCLE_GDSC_Analysis_Working_21_11_19"
author: "Kieran Redpath"
date: "21 November 2019"
output:
  github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Shortcuts

Ctrl Shift M = %>%

Alt - = <-

Ctrl Alt I = Insert new R chunk

Ctrl Alt M = Git commit

## What exactly are these files?

DepMap-2018q3-celllines.csv: tells you more information about the cell lines

CCLE_mutations.csv: information on what mutations are present in CCLE cell lines

CCLE_RNAseq_genes_counts_20180929.gct: expression data for a bunch of genes in CCLE cell lines

gdsc_codes_1.csv: tells you about drugs (GDSC ID, actual name, etc.)

GDSC_AUC.csv: AUC data for GDSC cell lines, treated with a bunch of different drugs

GDSC_IC50.csv: IC50 data for GDSC cell lines, treated with a bunch of different drugs

# âœ“ denotes chunks that should definitely work fine and aren't broken

# 18_11_19
```{r Load Packages}
setwd("~/Documents/R Data/summer_project")
# Packages
library(limma)
library(edgeR)
library(data.table)
library(magrittr)
library(ggplot2)
library(CePa)
library(dplyr)
library(tidyverse)
library(ggbeeswarm)
```

```{r Data: Setup}
# Read Data
depMapCCLEmut <- fread('CCLE_GDSC/Data/CCLE_mutations.csv', sep=',')
dim(depMapCCLEmut)
depMapCCLElines <- fread('CCLE_GDSC/Data/DepMap-2018q3-celllines.csv', sep=',')
dim(depMapCCLElines)
# Check format of cell line info:
head(depMapCCLElines)
# Get cell line barcodes:
bc <- depMapCCLEmut$Tumor_Sample_Barcode
head(bc)
# Match barcodes to Broad IDs
mt <- match(bc, depMapCCLElines$Broad_ID)
sum(is.na(mt))
# Cell lines that don't match to Broad IDs
is.na(mt) %>%  which() %>% bc[.] %>% table()
# Extract disease and gene info
dis <- depMapCCLElines$`Primary Disease`[mt]
gn <- depMapCCLEmut$Hugo_Symbol
```



```{r CDH1}
# Number of CDH1 mutations
sum(gn == "CDH1")
# Lines with CDH1 mutations (ordered by mutation counts)
which(gn == "CDH1") %>% dis[.] %>% table() %>% sort(., decreasing=TRUE) 
# Ignore NSC Lung Cancer for now
diseases = c("Colon Cancer", "Gastric Cancer", "Breast Cancer")
kp <- bc[which(gn == "CDH1" & dis %in% diseases)]
# Colon, breast and gastric cell lines with CDH1 mutations
cdh1Lines <- depMapCCLElines %>% dplyr::filter(., Broad_ID %in% kp)
cdh1Lines %>% 
  dplyr::arrange(., `Primary Disease`) 
col_order_cdh1 <- c("CCLE_Name","Broad_ID","Aliases","COSMIC_ID","Sanger ID","Primary Disease","Subtype Disease","Gender","Source")
cdh1Lines <- cdh1Lines[, col_order_cdh1]
```



```{r Drug Data: Setup}
# Load Data
gdsc_auc <- read.csv('CCLE_GDSC/Data/GDSC_AUC.csv', sep=',')
gdsc_ic50 <- read.csv('CCLE_GDSC/Data/GDSC_IC50.csv', sep=',')
dim(gdsc_auc)
dim(gdsc_ic50)
gdsc_auc[1:5,1:5]
gdsc_ic50[1:5,1:5]
```



```{r Drug Data: Dasatinib}
# GDSC drug codes
drugCodes <- read.csv('CCLE_GDSC/Data/gdsc_codes_1.csv', sep= ',')
head(drugCodes)
# Find Dasatinib (drug_id is "51")
drugCodes %>% dplyr::filter(., drug_name == "Dasatinib")
# Extract Dasatinib data
dasatinib_ic50 <- gdsc_ic50 %>% dplyr::filter(., X=="GDSC:51")
dasatinib_auc <- gdsc_auc %>% dplyr::filter(., X=="GDSC:51")
# Count non-NA values (! means the opposite of is.na, so is *not* NA)
sum(!is.na(dasatinib_ic50))
sum(!is.na(dasatinib_auc))
# GDSC cell lines with Dasatinib AUC data
names(dasatinib_auc)[!is.na(dasatinib_auc)][-1]
head(dasatinib_ic50)[,1:5]
head(dasatinib_auc)[,1:5]
# Replace names with CCLE names
ic50_names <- match(names(dasatinib_ic50), 
                  gsub("-",".",depMapCCLElines$Broad_ID, fixed=TRUE))
names(dasatinib_ic50) <- depMapCCLElines$CCLE_Name[ic50_names]
head(dasatinib_ic50)[,1:5]

auc_names <- match(names(dasatinib_auc), 
                  gsub("-",".",depMapCCLElines$Broad_ID, fixed=TRUE))
names(dasatinib_auc) <- depMapCCLElines$CCLE_Name[auc_names]
head(dasatinib_auc)[,1:5]
```



```{r CCLE Expression Data Setup/Test}
# Load data, convert to table
ccleExpData <- read.gct('CCLE_GDSC/Data/CCLE_RNAseq_genes_counts_20180929.gct')
dim(ccleExpData)
# Data are read counts and ensembl gene IDs
ccleExpData[1:5,1:5]
# Log the data (add 0.5 to avoid log(0))
logExpDat <- log(ccleExpData + 0.5)
# Density plots to assess consistency-> data are consistent with one another -> will normalise this next
plot(density(logExpDat[,1]))
for(i in 2:ncol(logExpDat)) lines(density(logExpDat[,i]))
```



```{r CCLE Expression Data Normalised/Unfiltered}
# Normalise via limma::voom (see page 70 of Limma usersguide)
# Note - I'm not filtering the genes
dge <- DGEList(counts=ccleExpData)
dge <- calcNormFactors(dge)

v <- voom(dge, plot=TRUE)

# Extract the normalised expression data
# Note that the voom procedure produces logged data
expDat <- v$E

# Plot the post-normalised data. "expDat" is the important bit, that you'll filter then graph
# Note there is now less variation in the "bump" above 5 - instead the 
# variation has been "moved" to the very low abundance genes (below -5).
plot(density(expDat[,1]))
for(i in 2:ncol(expDat)) lines(density(expDat[,i]))

expDat[1:5,1:5]
```



## Now you can start having a play with the expression data in combination with the Dasatinib AUC and IC50 information. Can also add in CDH1 mutation data as needed.

# 19_11_19
```{r Extract Tissue Info for IC50, AUC, and expDat}
#Here you will create the useful files that you will graph later on- these contain data only for those cell lines that we have CDH1 expression data, CDH1 mutation status, IC50, and AUC for.
#Create a vector containing the shared sample names (the intersect of identical data). It doesn't matter that this just uses expression and ic50, as any samples we have IC50 for, we also have auc for.
commonSamples <- intersect(names(dasatinib_ic50),colnames(expDat))
head(commonSamples)
# Figure out which IC50 observations are within commonSamples (match)
ic50_match <- match(commonSamples, names(dasatinib_ic50))
# Interpret this (e.g. the 18th entry in dasatinib_ic50 matches the first entry in commonSamples)
head(ic50_match)
# Figure out which IC50 observations are within commonSamples (match)
auc_match <- match(commonSamples, names(dasatinib_auc))
# Interpret this 
head(auc_match)
# Figure out which expDat observations are within commonSamples (match)
##################### There's a small chance that this is wrong, but I don't think so (colnames, not names)
expDat_match <- match(commonSamples, colnames(expDat))
head(expDat_match)

#These "*_sort" objects will be what you create graphs from later on

# Create a new IC50 variable containing samples from commonSamples (na.omit) and sorted in the same order (also due to na.omit)
dasatinib_ic50_sort <- dasatinib_ic50[na.omit(ic50_match)]
# Create a new auc variable containing samples from commonSamples (na.omit) and sorted in the same order (also due to na.omit)
dasatinib_auc_sort <- dasatinib_auc[na.omit(auc_match)]
# Create a new expDat variable containing samples from commonSamples (na.omit) and sorted in the same order (also due to na.omit)
expDat_sort <- expDat[ , na.omit(expDat_match)]

# strsplit takes each "names" data, splitting it at each "_", creating a list.
# lapply takes each list entry from this, dropping the first value (in this case, cell-line), then pastes the rest back together with "_".
# unlist converts the data from a list back to a vector.
# Define "tissue_sort"
tissue_sort <- strsplit(names(dasatinib_ic50_sort), "_") %>% 
  lapply(., function(x) paste0(x[-1], collapse='_')) %>%  
  unlist()
# Check numbers for each tissue type
table(tissue_sort)

# Note that the order is now the same
dasatinib_auc_sort[1:5]
dasatinib_ic50_sort[1:5]
```



# 20_11_19

## CCLE_dasat_BCCCGC is *all* BC, CC, and GC lines with GDSC data
```{r Find Information on Dasatinib Treatment for CDH1 Mutant Breast, Colon and Gastric Cancer Lines}
# Create the filtered file, removing cell line info. Leaves you with IC50 for BC, CC, GC
tissue_sort_BCCCGC <- strsplit(names(dasatinib_ic50_sort), "_") %>% 
  lapply(., function(x) paste0(x[-1], collapse='_')) %>%  
  unlist()
dasat_ic50_BCCCGC <- dasatinib_ic50_sort[tissue_sort == "STOMACH" | tissue_sort == "BREAST" | tissue_sort == "LARGE_INTESTINE"]
# Create the filtered file, removing cell line info. Leaves you with AUC for BC, CC, GC
tissue_sort_BCCCGC2 <- strsplit(names(dasatinib_auc_sort), "_") %>% 
  lapply(., function(x) paste0(x[-1], collapse='_')) %>%  
  unlist()
dasat_auc_BCCCGC <- dasatinib_auc_sort[tissue_sort_BCCCGC2 == "STOMACH" | tissue_sort_BCCCGC2 == "BREAST" | tissue_sort_BCCCGC2 == "LARGE_INTESTINE"]
# Combine these two files
dasat_data_BCCCGC <- rbind(dasat_auc_BCCCGC, dasat_ic50_BCCCGC)
rownames(dasat_data_BCCCGC) <- c("AUC","IC50")
dasat_data_BCCCGC <- t(dasat_data_BCCCGC)

# Create a file with cell line info to combine with "dasat_data_BCCCGC"
CCLElinesBCCCGC <- depMapCCLElines %>%
  filter(`Primary Disease`=="Gastric Cancer"|`Primary Disease`=="Breast Cancer" |`Primary Disease`=="Colon Cancer")
# Rename CCLElinesBCCCGC rows
l <- as.list(CCLElinesBCCCGC$CCLE_Name)
rownames(CCLElinesBCCCGC) <- l
CCLElinesBCCCGC <- select (CCLElinesBCCCGC, -c(CCLE_Name))

## One way to combine data by a specific thing:
# Combine dasatinib data and CCLElinesBCCCGC
CCLE_dasat_BCCCGC <- merge(CCLElinesBCCCGC,dasat_data_BCCCGC,by=0, all=T)
names(CCLE_dasat_BCCCGC)[names(CCLE_dasat_BCCCGC) == 'Row.names'] <- 'CCLE_Name'
View(CCLE_dasat_BCCCGC)
```



# 21_11_19

## Create a file with CDH1 non-mutants
```{r CDH1 Non-mutants}
# Number of lines without CDH1 mutations
sum(gn != "CDH1")
# Lines without CDH1 mutations (ordered by mutation counts)
which(gn != "CDH1") %>% dis[.] %>% table() %>% sort(., descending = TRUE)
# Ignore NSC Lung Cancer for now
diseases = c("Colon Cancer", "Gastric Cancer", "Breast Cancer")
kk <- bc[which(gn != "CDH1" & dis %in% diseases)]
# Colon, breast and gastric cell lines without CDH1 mutations
Noncdh1Lines <- depMapCCLElines %>% dplyr::filter(., Broad_ID %in% kk)
Noncdh1Lines %>% 
  dplyr::arrange(., `Primary Disease`)
col_order_Noncdh1 <- c("CCLE_Name","Broad_ID","Aliases","COSMIC_ID","Sanger ID","Primary Disease","Subtype Disease","Gender","Source")
Noncdh1Lines <- Noncdh1Lines[, col_order_Noncdh1]

# Open the new data and the old data. these files will probably be used later on
View(Noncdh1Lines)
View(cdh1Lines)
```



# 25_11_19

## Add CDH1 mutation data to the existing table, then create a boxplot with CDH1 mutants and non-CDH1 mutants next to each other, telling you about IC50 and AUC values
```{r AUC and IC50 Plots- Intro Version}
# Add CDH1_Mutations column to CCLE_dasat_BCCCGC
CCLE_dasat_BCCCGC$CDH1_Mutations="Zero"
# Add AUC, IC50, and CDH1_Mutations columns to cdh1Lines
cdh1Lines$AUC=NA
cdh1Lines$IC50=NA
cdh1Lines$CDH1_Mutations="One"
# Use match to combine the two. Takes all those observations from cdh1Lines and incorporates them into "CCLE_dasat_BCCCGC$CDH1_Mutations", calling them "One" if they're present in cdh1Lines, leaving the "Zero" if they aren't
# Join would be better, so probably use that next time
Boxplot_data <- match(cdh1Lines$CCLE_Name, CCLE_dasat_BCCCGC$CCLE_Name)
CCLE_dasat_BCCCGC$CDH1_Mutations[Boxplot_data] <- "One"
# Also create a column for later ("CDH1_Expression")
CCLE_dasat_BCCCGC$CDH1_Expression= NA

# AUC ggplot (with CDH1 mutation status)
ggplot(data=CCLE_dasat_BCCCGC, mapping=aes(x=CDH1_Mutations, y=AUC, fill=CDH1_Mutations)) +
  labs(x="Number of CDH1 Mutations", y="AUC", caption="(Data from GDSC and CCLE)") +
  ggtitle("Dasatinib Data", subtitle="AUC vs Number of CDH1 Mutations") +
  geom_boxplot()+
  geom_beeswarm()
# C50 ggplot (with CDH1 mutation status)
ggplot(data=CCLE_dasat_BCCCGC, mapping =aes(x=CDH1_Mutations, y=IC50, fill=CDH1_Mutations)) +
  labs(x="Number of CDH1 Mutations", y="IC50", caption="(Data from GDSC and CCLE)") +
  ggtitle("Dasatinib Data", subtitle="IC50 vs Number of CDH1 Mutations") +
  geom_boxplot() +
  geom_beeswarm()
```



```{r Add CDH1 Expression Data, to plot it on the boxplot later}
# Attempt to create a data frame that just has data for CDH1 (Ensembl: ENSG00000039068.14), but across every cell line
CDH1_Exp_Levels <- subset(expDat_sort, rownames(expDat_sort)=="ENSG00000039068.14")
#Reorient "CDH1_Exp_Levels" so it has the same orientation as "CCLE_dasat_BCCCGC"
CDH1_Exp_Levels <- t(CDH1_Exp_Levels)
View(CDH1_Exp_Levels)
# Move row names into the first column, and name it "CCLE_Name"
CDH1_Exp_Levels <- as.data.frame(CDH1_Exp_Levels)
setDT(CDH1_Exp_Levels, keep.rownames = "CCLE_Name")[]
# Filter so lowest 40% is "Low", top 80% is "High" (can replace values later on)
CDH1_Exp_Levels$CDH1_Expression <- ifelse(CDH1_Exp_Levels$ENSG00000039068.14 < quantile(CDH1_Exp_Levels$ENSG00000039068.14, 0.4), "Low","High")
```



```{r Save Some Important Files for the Next Steps}
#This will be used a lot in the next document
write.csv(CCLE_dasat_BCCCGC,"~/Documents/R Data/summer_project/CCLE_GDSC/Data/CCLE_dasat_BCCCGC.csv", row.names = FALSE)
write.csv(CDH1_Exp_Levels,"~/Documents/R Data/summer_project/CCLE_GDSC/Data/CDH1_Exp_Levels.csv", row.names = FALSE)
```


